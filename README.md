[![pipeline status](https://gitlab.com/toptalo/diafilm/badges/master/pipeline.svg)](https://gitlab.com/toptalo/diafilm/commits/master)

# Описание проекта

Проект собирается из исходников с помощью [Grunt](http://gruntjs.com/) и [Node.js](http://nodejs.org/)

В проекте используются следующие фреймворки:

* `Modernizr` - библиотека проверки доступности фич браузера [modernizr.com](https://modernizr.com/)
* `jQuery` - JavaScript библиотека [jquery.com](http://jquery.com/)
* `Grunt` - инструмент для сборки проектов [gruntjs.com](http://gruntjs.com/)
* `SCSS` - CSS препроцессор расширяющий возможности CSS [sass-lang.com](http://sass-lang.com/)
* `Twig` - HTML шаблонизатор [Twig](https://twig.symfony.com/)
* `Jest` - Платформа для тестирования JavaScript [Jest](https://jestjs.io/ru/)
* `Puppeeter` - Библиотека для запуска Chromium из Node [Puppeteer](https://github.com/GoogleChrome/puppeteer)

### Клонирование:
1. `git clone ...`
2. В проекте используется [Git LFS](https://docs.gitlab.com/ce/workflow/lfs/manage_large_binaries_with_git_lfs.html), необходимо установить
3. `git lfs fetch origin master`

### Структура:

```
└── project/ - корневая директория проекта
    ├── _conf/dev/ - статика Django проекта
    │   └── robots.txt - директивы для поисковых роботов, окружения разработки
    ├── core/static/ - статика Django проекта
    │   ├── core/ -
    │   │   ├── css/ - стили
    │   │   ├── fonts/ - шрифты
    │   │   ├── icons/ - иконки для мобильных и плиток
    │   │   ├── img/ - изображения - элементы дизайна
    │   │   ├── js/ - яваскрипты
    │   │   ├── markup-media/ - медиафайлы для верстки (изображения, видео, аудио)
    │   │   ├── browserconfig.xml - [XML-файл конфигурации браузера](https://msdn.microsoft.com/ru-ru/library/dn455106(v=vs.85).aspx)
    │   │   ├── humans.txt - описание команды и проекта
    │   │   └── manifest.json - [Web App Manifest](https://www.w3.org/TR/appmanifest/)
    │   └── vendor/ - сторонние библиотеки
    ├── git_hooks/ - папка хухов гита
    │   ├── add.sh - скрипт для создания симлинка в хуках гита
    │   └── post-merge - хук на `git pull`
    ├── markup/ - корневая директория верстки
    │   ├── ajax/ - сниппеты для ajax запросов
    │   ├── js/ - JavaScript проекта
    │   │   ├── global/ - глобальные скрипты, необходимые на всех страницах сайта, влияющие на отрисовку страницы
    │   │   │   ├── plugins/ самописные jQuery плагины для создания эфекта модульности
    │   │   │   └── async/ глобальные скрипты, необходимые на всех страницах сайта, не влияющие на отрисовку страницы и могут быть загружены асинхронно
    │   │   │       └── plugins/ самописные jQuery плагины для создания эфекта модульности
    │   │   └── {имя шаблона}/ - скрипты шаблона страницы, влияющие на отрисовку страницы
    │   │       ├── plugins/ самописные jQuery плагины для создания эфекта модульности
    │   │       └── async/ скрипты шаблона страницы, не влияющие на отрисовку страницы и могут быть загружены асинхронно
    │   │           └── plugins/ самописные jQuery плагины для создания эфекта модульности
    │   ├── node_scripts/ - скрипты, хуки для ноды
    │   │   ├── postinstall.js - добавляет симлинк на статику
    │   │   ├── server.js - локальный сервер
    │   │   └── twig-helpers.js - кастомные функции и фильтры для шаблонизатора Twig.js (twig2html)
    │   ├── scss/ - стили сайта
    │   │   ├── blocks/ - стили блоков и секций сайта
    │   │   ├── core/ - общие стили и настройки, инклюды
    │   │   ├── global.scss - глобальные стили сайта
    │   │   ├── .stylelintrc - правила Stylelint для проверки *.scss
    │   │   └── {имя шаблона}.scss - стили шаблона страницы
    │   ├── sprite/ - отдельные изображения, которые будут собраны в спрайт (PNG, SVG)
    │   ├── templates/ - шаблоны сайта
    │   │   ├── ajax/ - генерируемые сниппеты для ajax запросов
    │   │   ├── blocks/ - блоки сайта
    │   │   ├── layouts/ - шаблоны страниц сайта
    │   │   ├── pages/ - страницы сайта
    │   │   ├── base.twig - базовый шаблон сайта
    │   │   └── context.json - переменные проекта
    │   ├── tests/ - папка тестов
    │   │   ├── __image_snapshots__/ - скриншоты страниц
    │   │   ├── reset.css - переопределение стилей перед тестом
    │   │   ├── reset.js - скрипты для выполнения перед тестом
    │   │   ├── visualTest.js - базовый тест
    │   │   └── visual.*.test.js - визуальные тесты
    │   ├── .browserslistrc - список поддерживаемых браузеров
    │   ├── Gruntfile.js - настройки заданий Grunt
    │   ├── jest.config.js - настройки Jest
    │   ├── *.html - страницы сайта
    │   └── package.json - зависимости Grunt проекта
    ├── .editorconfig - настройки редактора
    ├── .eslintignore - список файлов и директорий которые не должен проверять ESLint
    ├── .eslintrc - правила ESLint
    ├── .gitlab-ci.yml - конфигурация gitlab CI
    ├── .nvmrc - фиксация версии node.js для nvm
    ├── .stylelintignore - список файлов и директорий которые не должен проверять Stylelint
    ├── .stylelintrc - правила Stylelint для проверки *.css
    └── .yaspellerrc - настройки и искгючения проверки орфографии

```

## Разработка

### Скрипты

Скрипты располагаются в папке `markup/js` и группируются по папкам, по имени шаблона страницы или самой страницы на
которой они должны быть подключены. Во время сборки эти скрипты конкатинируются в файл `%ИМЯ_ПАПКИ%.js`
Скрипты необходимые на разных шаблонах собираются в папке `global/`.

В эту папку помещаются скрипты влияющие на отрисовку страницы (галереи, аккордеоны, графики, и т.п.)
Эти скрипты будут подключены на страницу синхронно.

В каждой папке создается подпапка `plugins/` в неё складываются плагины которые при конкатинации пойдут в начале файла.

А также создается подпапка `async` в которой также есть подпапка `plugins` - в эти директории помещаются скрипты и плагины
работа которых не влияет на начальную отрисовку страницы и могут быть загружены асинхронно (атрибут `async` или `defer` на теге `<script>`)
Во время сборки эти скрипты конкатинируются в файл `%ИМЯ_ПАПКИ%-async.js`

### Спрайты

PNG Спрайт собирается автоматически с помощью плагина [grunt-spritesmith](https://github.com/Ensighten/grunt-spritesmith)
Иконки складываются в папку `murkup/img/sprite`, по два файла на одну иконку (1x и 2x версии, к имени 2x версии иконки
дописывается постфикс `@2x`)

SVG Спрайт собирается автоматически с помощью плагина [grunt-svg-sprite](https://github.com/jkphl/grunt-svg-sprite)
Иконки складываются в папку `murkup/img/sprite`

## Сборка проекта с помощью Grunt

1. Переходим в папку верстки

   ```bash
   $ cd markup/
   ```
2. Устанавливаем [Node.js](http://nodejs.org/)

3. Устанавливаем зависимости проекта:

    ```bash
    $ npm install
    ```

После установки пакетов будет создан симлинк на папку со статикой `core/static` в папке `markup/static`.
В этой папке будут лежать файлы стилей, скриптов, шрифты, картинки в папке `core` и все вендорные скрипты
в папке `vendor`. А также будет создан симлинк на git hook `post-merge`, который предупредит в консоли,
если после pull'а потребуются дополнительные действия. 

В шаблонах следует указывать следующие пути `/static/vendor/jquery.min.js` - для подключения jQuery и прочих
вендорных скриптов и пути типа `/static/core/css/`, `/static/core/js/`, `/static/core/img/`,
`/static/core/markup-media/` - для остальной статики. Это сделано для того чтобы избежать дублирования
файлов в верстке и готовом проекте.

### Кастомные функции и фильтры `twig_helpers.js`

Есть функции:

* `{{ core('css/global.css') }}` - возвращает путь для `/static/core/css/global.css` 
* `{{ vendor('js/jquery.min.js') }}` - возвращает путь для `/static/vendor/js/jquery.min.js` 
* `{{ media('image.jpg') }}` - возвращает путь для `/static/core/markup-media/image.jpg`
* `{ % set targetMenu = getMenu(menu, id/path/slug) % }` - возвращает массив `childrens` объекта меню с заданным `id`, `path` или `slug`
* `{ % set menuItem = getMenuItem(menu, id/path/slug) % }` - возвращает объект меню с заданным `id`, `path` или `slug`
* `{{ getPageTitle(page, menu) }}` - возвращает заголовок страницы из меню, сопоставляя по `page.id`

Есть фильтры:

* `{{ 'text'|slug }}` - возвращает слаг для строки `text` (нормализованную строку) 
* `{{ 'text'|ft }}` - типографика (длинное тире, пробелы) 
* `{{ '11590'|digit }}` - возвращает число разбитое по разрядам `11 590`
* `{{ '+7 (963) 717-51-90'|phone2numeric }}` - возвращает чистый номер `+79637175190` 
* `{{ menu|url(id/path/slug) }}` - возвращает `link` из пункта меню `menu` с заданным `id`, `path` или `slug` 
* `{{ menu|match(key, value) }}` - вернет пункты меню у которых `key` === `value` 
* `{{ '1024'|fileSize }}` - вернет `1,0 кб`
* `{{ loop.index|hash }}` - делает хеш из числа, удобно для айдишников
* `{{ loop.index|cycle('one', 'two', 'three') }}` - выводит в цикле строки
* `{{ self.image|extend({ defaults }) }}` - 
* `{{ 'block'|extra({paramName:ParamValue}) }}` - 
* `{{ menu|getParentFor(id/path/slug) }}` - возвращает родителя по меню
* `{{ 'block'|mod('a, b', sep:gruntParams.bem['_'], skipDefault:false) }}` - добавляет БЭМ модификаторы к классу  
* `{{ |retina(?postfix) }}` - добавляет постфикс в имя файла, по умолчанию `@2x`
* `{ % if string|test('regExp', 'flags') % }` - проверяет строку на соответствие шаблону
* `{{ |webp }}` - заменяет расширение файла на `.webp`

---

Для того чтобы **по-новому пересобрать** все файлы нужно выполнить команду `grunt` или `grunt default`

Для того чтобы пересобрать файлы **пред пушем** - `grunt deploy`, остановив `develop` задание
Для того чтобы пересобрать меню в `context.json` - `grunt menu`

**На время работы** - `grunt develop` или `grunt watch`

---

Есть виртуальный сервер для верстки - команда `grunt connect` - запустит сервер и верстка станет доступной
по адресу [http://localhost:8210/](http://localhost:8210/), порт можно изменить в файле `Gruntfile.js`

Также есть задание для теста верстки - `grunt test` - проверит html страницы на соответствие стандарту w3c,
стили и скрипты на наличие ошибок
